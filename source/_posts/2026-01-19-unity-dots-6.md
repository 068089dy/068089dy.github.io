---
title: Unity DOTS学习记录(六)-一些常用操作
date: 2026-01-28 16:54:46
tags: 
- unity 
- ECS
- 面向数据
- 高性能
- DOTS
keywords: [unity, ECS, DOTS, 面向数据]
---
环境：
Unity：6000.2.10f1
Entities：1.4.3

参考：
https://github.com/Unity-Technologies/EntityComponentSystemSamples


## 实例化预设Prefab
```c#
public class TurretRotationAuthoring : MonoBehaviour
{
    public GameObject bulletPrefab;
    class TurretRotationBaker : Baker<TurretRotationAuthoring>
    {
        public override void Bake(TurretRotationAuthoring authoring)
        {
            // The entity will be moved
            var entity = GetEntity(TransformUsageFlags.Dynamic);
            // 为实体添加组件数据
            AddComponent(entity, new TurretShootComponent()
            {
                BulletPrefab = GetEntity(authoring.bulletPrefab, TransformUsageFlags.Dynamic)
            });
        }
    }
}

public struct TurretShootComponent : IComponentData
{
    public Entity BulletPrefab;
}


[BurstCompile]
public partial struct TurretShootJob : IJobEntity
{
    public float DeltaTime;
    public EntityCommandBuffer.ParallelWriter ECB;
    void Execute([EntityIndexInQuery] int sortKey, ref LocalTransform transform，ref TurretShootComponent shootComponent, Entity entity)
    {
        // ECB实例化实体
        Entity bullet = ECB.Instantiate(sortKey, shootComponent.BulletPrefab);
        // 给实体设置组件
        ECB.SetComponent(sortKey, bullet, component);
    }
}
```


## 实体/组件操作

### 主线程中：

* 获取实体单例：
```c#
Entity _entity;
SystemAPI.TryGetSingletonEntity<CharacterAgentComponent>(out _entity)

Entity e = SystemAPI.GetSingletonEntity<MyComponent>();
```
* 获取实体上的组件：
```
LocalTransform playerTransform =
                SystemAPI.GetComponent<LocalTransform>(_entity);
```
* 根据组件获取实体：
```c#
EntityQuery query = SystemAPI.QueryBuilder()
    .WithAll<MyComponent>()
    .Build();
// 转化为列表
using var entities = query.ToEntityArray(Allocator.Temp);
```
或者用foreach
```c#
foreach (var (comp, entity) in 
         SystemAPI.Query<RefRO<MyComponent>>()
                  .WithEntityAccess())
{
    // entity 就是挂着 MyComponent 的实体
}
```



### Job/子线程中

* ECB操作
`ECB`是`ECS`的事务系统（不过没有回滚，执行失败会报错，但不影响其他的命令）
```c#
// Update中
void OnUpdate(ref SystemState state){
    var ecb = SystemAPI
                    .GetSingleton<EndSimulationEntityCommandBufferSystem.Singleton>()
                    .CreateCommandBuffer(state.WorldUnmanaged).AsParallelWriter();
    new BulletMoveJob{
        DeltaTime = SystemAPI.Time.DeltaTime
    }.ScheduleParallel();
}


[BurstCompile]
public partial struct BulletMoveJob : IJobEntity
{
    public float DeltaTime;
    public EntityCommandBuffer.ParallelWriter ECB;
    void Execute([EntityIndexInQuery] int sortKey, ref LocalTransform transform，ref BulletMoveComponent moveComponent, Entity entity)
    {
        // ECB实例化实体
        Entity bullet = ECB.Instantiate(sortKey, shoot.BulletPrefab);
        // 给实体设置组件
        ECB.SetComponent(sortKey, bullet, component);
        // 添加组件
        ECB.AddComponent(sortKey, entity, new Health { Value = 100 });
        // 删除组件
        ECB.RemoveComponent<DeadTag>(sortKey, entity);
        // 销毁实体
        ECB.DestroyEntity(sortKey, entity);
    }
}
```
* 注意，`ECB.AddComponent`添加组件后，不能马上读到这个组件，需要等到下一帧
`ECB`是`ECS`的事务系统：
`Job`里只提交命令，
命令在当前帧的`ECB System Playback`时统一执行，
`Playback`之后`World`立即改变，
但只有在`Playback`之后运行的系统（通常是下一帧）才能观察到这些变化。

* 获取实体上的组件
```c#
void OnUpdate(ref SystemState state) {
    var ltLookup = SystemAPI.GetComponentLookup<LocalTransform>(true);
    // 将ltLookup传入Job中
    new TurretShootJob
        {
            ltLookup = SystemAPI.GetComponentLookup<LocalTransform>(true)
        }.ScheduleParallel();
}

[BurstCompile]
public partial struct TurretShootJob : IJobEntity
{
    [ReadOnly] public ComponentLookup<LocalTransform> ltLookup;
    void Execute([ChunkIndexInQuery] int sortKey,
            ref TurretShootComponent shoot,
            in LocalToWorld muzzleLtw){

        // 判断entity有没有LocalTransform
        if (ltLookup.HasComponent(entity)){
            LocalTransform lt = ltLookup[entity];
        }
    }
}
```